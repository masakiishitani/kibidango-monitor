name: Check Kibidango Project

on:
  # æ¯æ—¥åˆå‰10æ™‚ï¼ˆJST = UTC+9ï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 1 * * *'  # UTC 1:00 = JST 10:00

  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm ci
          # PuppeteerãŒæ­£ã—ãå‹•ä½œã™ã‚‹ãŸã‚ã«å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npx puppeteer browsers install chrome

      - name: ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        id: check
        run: |
          output=$(node check.js)
          echo "$output"

          # Issueä½œæˆãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
          if echo "$output" | grep -q "ISSUE_BODY"; then
            echo "CREATE_ISSUE=true" >> $GITHUB_ENV
            # Issueæœ¬æ–‡ã‚’æŠ½å‡º
            issue_body=$(echo "$output" | sed -n '/--- ISSUE_BODY ---/,/--- END_ISSUE_BODY ---/p' | sed '1d;$d')
            # è¤‡æ•°è¡Œã®æ–‡å­—åˆ—ã‚’GitHubç’°å¢ƒå¤‰æ•°ã«è¨­å®š
            echo "ISSUE_BODY<<EOF" >> $GITHUB_ENV
            echo "$issue_body" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data.json || true
          git diff --staged --quiet || git commit -m "ğŸ“Š Update project data [skip ci]"

      - name: ğŸ“¤ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        if: always()
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: ğŸ”” Issueã‚’ä½œæˆ
        if: env.CREATE_ISSUE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = process.env.ISSUE_BODY;
            const title = `ğŸ”” ãã³ã ã‚“ã”ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°é€šçŸ¥ - ${new Date().toLocaleDateString('ja-JP')}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: issueBody,
              labels: ['auto-generated', 'monitoring']
            });
